<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Suscripción CLUB VIAJEROS GOLD SILVER CTI</title>
<style>
body { font-family: Arial, sans-serif; max-width: 400px; margin: auto; padding: 20px; }
input, button { width: 100%; padding: 10px; margin: 10px 0; }
button { background-color: #28a745; color: white; border: none; font-size: 16px; cursor: pointer; }
h2 { text-align: center; color: #333; }
</style>
</head>
<body>
<h2>Suscripción: CLUB VIAJEROS GOLD SILVER CTI</h2>
<p>Monto mensual: <strong>$17.850 COP</strong></p>
<form id="subscriptionForm">
    <input type="text" id="fullName" placeholder="Nombre completo" required>
    <input type="email" id="email" placeholder="Correo electrónico" required>
    <input type="text" id="cardNumber" placeholder="Número de tarjeta" required>
    <input type="text" id="expMonth" placeholder="Mes (MM)" required>
    <input type="text" id="expYear" placeholder="Año (YYYY)" required>
    <input type="text" id="cvv" placeholder="CVV" required>
    <button type="submit">Suscribirme</button>
</form>

<p id="result"></p>

<script>
document.getElementById('subscriptionForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const fullName = document.getElementById('fullName').value;
    const email = document.getElementById('email').value;
    const cardNumber = document.getElementById('cardNumber').value;
    const expMonth = document.getElementById('expMonth').value;
    const expYear = document.getElementById('expYear').value;

    document.getElementById('result').innerText = 'Procesando, por favor espera...';

    try {
        // 1. Crear token de tarjeta
        const tokenResponse = await fetch('https://sandbox.api.payulatam.com/payments-api/4.0/service.cgi', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                language: "es",
                command: "CREATE_TOKEN",
                merchant: {
                    apiKey: "4Vj8eK4rloUd272L48hsrarnUA",
                    apiLogin: "pRRXKOl8ikMmt9u"
                },
                creditCardToken: {
                    payerId: email,
                    name: fullName,
                    identificationNumber: "0000000000",
                    paymentMethod: "VISA",
                    number: cardNumber,
                    expirationDate: expYear + "/" + expMonth
                }
            })
        });

        const tokenData = await tokenResponse.json();
        console.log(tokenData);

        if (!tokenData.creditCardToken || !tokenData.creditCardToken.creditCardTokenId) {
            document.getElementById('result').innerText = 'Error creando token';
            return;
        }

        const tokenId = tokenData.creditCardToken.creditCardTokenId;

        // 2. Crear suscripción
        const subscriptionResponse = await fetch('https://sandbox.api.payulatam.com/payments-api/rest/v4.9/subscriptions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': 'Basic ' + btoa("pRRXKOl8ikMmt9u" + ":" + "4Vj8eK4rloUd272L48hsrarnUA")
            },
            body: JSON.stringify({
                plan: {
                    planCode: "CLUB_VIAJEROS_GOLD_SILVER_CTI",
                    description: "Suscripción mensual CLUB VIAJEROS GOLD SILVER CTI",
                    accountId: "512321",
                    interval: "MONTH",
                    intervalCount: 1,
                    paymentAttemptsDelay: 1,
                    maxPaymentAttempts: 3,
                    maxPendingPayments: 1,
                    trialDays: 0,
                    additionalValues: [
                        { name: "PLAN_VALUE", value: "17850", currency: "COP" }
                    ]
                },
                customer: {
                    fullName: fullName,
                    email: email,
                    creditCards: [
                        {
                            token: tokenId,
                            paymentMethod: "VISA"
                        }
                    ]
                }
            })
        });

        const subscriptionData = await subscriptionResponse.json();
        console.log(subscriptionData);

        if (subscriptionData.id) {
            document.getElementById('result').innerText = '¡Suscripción creada exitosamente (Sandbox)!';
        } else {
            document.getElementById('result').innerText = 'Error creando suscripción';
        }

    } catch (error) {
        console.error(error);
        document.getElementById('result').innerText = 'Error en el proceso';
    }
});
</script>
</body>
</html>
